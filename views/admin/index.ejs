<%- include("../partials/head"); %>
<%- include("./add_script"); %>
<%- include("../partials/neck"); %>

<div id="loader"
 style="width: 100vw;height: 100vh;overflow: hidden;z-index: 100; position: absolute; top: 0;left: 0; display: flex;justify-content: center; align-items: center;background-color: #2c2821; color: #aeb9d6;"
 >
  <span>
    Loading...
  </span>
</div>

<div
    id="main"
class="bg-smoky-black-900/90 w-screen h-screen overflow-hidden text-smoky-black-200 flex justify-center">
  <div class="h-full w-[320px] bg-smoky-black-900 flex flex-col items-center justify-start relative">
  <span class="pt-8 pb-8 w-full text-2xl font-mono font-semibold flex justify-center items-center space-x-4 border-b-2 border-liberty-800/20 text-liberty-200">
    <i class="fa-regular fa-circle-dot text-5xl"></i>
    <span class="flex flex-col">
      <span>DASHBOARD</span>
      <span class="text-xs font-thin">
	<i class="fa-solid fa-user"></i>
	<span class="mt-1">
	  <%= username %>
	</span>
      </span>
    </span>
  </span>
  <button class="text-xl w-full flex justify-between pt-5 pl-10 space-x-2 items-center border-b-2 border-liberty-800/20 pb-5 text-steel-blue-200" onclick="handlePage('add-blogs')">
    <span>Add BLog</span>
    <i class="fa-solid fa-plus pr-14"></i>
  </button>  
  <button class="text-xl w-full flex justify-between pt-5 pl-10 space-x-2 items-center border-b-2 border-liberty-800/20 pb-5 text-steel-blue-200" onclick="handlePage('add-topics')">
    <span>Add Topic</span>
    <i class="fa-solid fa-plus pr-14"></i>
  </button>  
  <button class="text-xl w-full flex justify-between pt-5 pl-10 space-x-2 items-center border-b-2 border-liberty-800/20 pb-5 text-steel-blue-200" onclick="handlePage('view-blogs')">
    <span>View Blogs</span>
    <i class="fa-regular fa-eye pr-14"></i>
  </button>  
  <button class="text-xl w-full flex justify-between pt-5 pl-10 space-x-2 items-center border-b-2 border-liberty-800/20 pb-5 text-steel-blue-200" onclick="handlePage('view-topics')">
    <span>View Topics</span>
    <i class="fa-regular fa-eye pr-14"></i>
  </button>  
  <a href="admin/logout" class="text-xl w-full flex justify-between mt-5 pl-10 space-x-2 items-center pb-5 absolute bottom-0 left-0 border-t-2 border-liberty-800/20 pt-5 text-liberty-300">
    <span>Logout</span>
    <i class="fa-solid fa-right-from-bracket pr-14"></i>
  </a>  
</div>

<div class="w-full  overflow-auto overflow-x-hidden">
  <% if(locals.message) { %>
  <div id="message-container" class="flex w-full justify-center items-start relative p-2 bg-liberty-700 font-semibold text-liberty-100">
    <span><%= message %></span>
    <button
      onclick="document.getElementById('message-container').remove()"
      class="absolute top-0 right-0 p-2 pt-3 pr-5">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
  <% } %>
  
  <div class="flex w-full justify-start items-center font-semibold">
	<div class="bg-amazon-800 p-1 w-full">
	    Blogs:  <%= blogs.length %>
	</div>
	<div class="bg-teal-800 p-1 w-full">
	    Topics:  <%= topics.length %>
	</div>
	<div class="bg-cyan-800 p-1 w-full">
	  Comments: <%= comments.length %>
	</div>
	<div class="bg-pink-800 p-1 w-full">
	  <% 
	     let published = 0
	     blogs.forEach((b) => { if(b.blog_publish == true){ published++ } })
	  %>
	  Published: <%= published %> 
	</div>
  </div>

  <div class="w-full">
  	<div class="p-5 pt-3 text-3xl w-full hidden" id="add-blogs">
	  <form action="admin/save_blog" method="post">
	  	<input type="text" class="p-2 text-md w-full bg-smoky-black-700 mb-8 mt-3 text-liberty-400 rounded-md" placeholder="Title ~ Untitled" name="blog_title">
	  	<textarea class="blog-editor" name="blog_content"></textarea>
		<textarea type="text" name="blog_description" class="p-2 text-md w-full bg-smoky-black-700 mb-5 mt-8 text-liberty-400 rounded-md" placeholder="Description ~"></textarea>
		<% if(locals.topics && topics.length > 0 ){ %>
		<select name="blog_topic"
		  class="text-md p-1 w-full bg-smoky-black-700 mb-5
		  text-liberty-400 rounded-md">
		  <option selected disabled hidden>Select Topic</option>
		  <% topics.forEach((topic) => { %>
		  <option value="<%= topic.topic_id %>">
		  <%= topic.topic_title %>
		  </option>
		  <% }) %>
		</select>
		<button class="bg-liberty-600 text-smoky-black-200 p-2 w-full rounded-md hover:bg-liberty-700">
		  Save
		</button>
		</form>
		<% } else { %>
			<span class="text-french-raspberry-600 text-xl font-semibold mt-5 p-2">
			  <i class="fa-solid fa-triangle-exclamation"></i>
			  Create a Topic First!!
			</span>
		<% } %>
	</div>

  	<div class="p-5 pt-3 text-3xl w-full hidden" id="add-topics">
	  <form action="admin/save_topic" method="post">
	    <input type="text" class="p-2 text-md w-full bg-smoky-black-700 mt-8 text-liberty-400 rounded-md mb-3"
	    placeholder="Topics ~ Untitled" name="topic_title">
		<textarea type="text" name="topic_description" class="p-2 text-md w-full bg-smoky-black-700 mb-5 mt-5 text-liberty-400 rounded-md" placeholder="Topic Description ~"></textarea>
		<button class="bg-liberty-600 text-smoky-black-200 p-2 w-full rounded-md hover:bg-liberty-700" type="submit">
		  Save
		</button>
	  </form>
	</div>

  	<div class="p-5 pt-3 text-3xl w-full hidden" id="view-blogs">
		      
	<% if(blogs.length > 0) { 
		    blogs.forEach((blog) => {
	%>
	  <div class="p-1 mt-5 mb-5 w-full 
	    flex justify-between bg-smoky-black-700 text-liberty-300 rounded-md items-center">
			  <div class="flex flex-col capitalize p-1">
			    <span class="text-2xl">
			      <%= blog.blog_title %> (<%= blog.blog_topic %>)
			    </span>
			    <span class="text-sm ">
			      <%= blog.blog_description %>
			    </span>
			  </div>
			  <div class="flex space-x-3">

			  <button class="mr-5 hover:text-liberty-500" type="submit" 
			    onclick="document.querySelector('#preview-<%= blog.blog_id %>').classList.remove('hidden')"                            >
			      <i class="fa-regular fa-eye"></i>
			  </button>

			  <form action="admin/edit_blog/<%= blog.blog_id %>" method="post">
			  <button class="mr-5 hover:text-sky-300" type="submit">
			    <i class="fa-solid fa-pen-to-square"></i>
			  </button>
			  </form>
			
			  <% if(blog.blog_publish == true){ %>
			  <form action="admin/unpublish/<%= blog.blog_id %>" method="post">
			  <button class="mr-5 hover:text-rose-500" type="submit">
			    <i class="fa-solid fa-xmark"></i>
			  </button>
			  </form>
			  <% } else {%>
			  <form action="admin/publish/<%= blog.blog_id %>" method="post">
			  <button class="mr-5 hover:text-green-500" type="submit">
			    <i class="fa-solid fa-check"></i>
			  </button>
			  </form>
			  <%}%>
			  
			  <form action="admin/delete_blog?blog_id=<%= blog.blog_id %>" method="post">
			  <button class="mr-5 hover:text-rose-500" type="submit">
			      <i class="fa-solid fa-trash"></i>
			  </button>
			  </form>
			  </div>
			</div>
			<div class="w-screen h-screen bg-smoky-black-800 overflow-x-hidden overflow-y-auto
			  absolute top-0 left-0 hidden flex items-center flex-col space-y-5"
			  id="preview-<%= blog.blog_id %>">
			  <div class="flex p-2 justify-between bg-smoky-black-900/50 w-full">
			    <span class="font-semibold text-2xl">
			      <%= blog.blog_title %>
			    </span>
			    <button class="text-3xl text-liberty-200 hover:text-rose-500 mr-5" 
			    onclick="document.getElementById('preview-<%= blog.blog_id %>').classList.add('hidden')">
				  <i class="fa-solid fa-xmark"></i>
				</button> 	
			  </div>
			  <div class="text-start w-[300px] md:w-[600px] lg:[800px] xl:w-[80%]">
			    <div class="revert-tailwind blog-container">
			      <%- blog.blog_content %>
			      <div
				style="background-color:#40403f90;border-radius:0.375rem;padding: 0.75rem;
				margin-top:4.5rem; margin-bottom: 1rem;"
				>
				<span class="font-semibold text-xl">Comments:</span>
				<% 
				  let isComment = false;
				  if(comments.length > 0){
				  comments.forEach((comment) => {
				  if(comment.blog_id == blog.blog_id){
				  if(!isComment){ isComment = true; }
				%>
				<div class="p-2 flex justify-between text-liberty-300
				  bg-smoky-black-800/50 rounded-md mt-3 mb-3 items-center">
				  <% const comment_date = comment.comment_creation.toString().split(" ") %>
				  <span><%- comment.comment %> - (<%= comment_date[2] + "-" + comment_date[1] + "-" + comment_date[3] %>)</span>
				  <form action="admin/delete_comment?comment_id=<%= comment.comment_id %>"
				    method="post">
				  <button class="mr-3 hover:text-rose-500" type="submit">
				    <i class="fa-solid fa-trash"></i>
				  </button>
				  </form>
				</div>
				<%
				    }})} else if(!isComment){
				%>
			      <span class="text-french-raspberry-600 text-xl font-semibold mt-5 p-2">
				No Comments Yet!
			      </span>
			      <% } %>
			      </div>
			    </div>
			  </div>
			</div>
			<%  })} else { %>
			<span class="text-french-raspberry-600 text-xl font-semibold mt-5 p-2">
			  <i class="fa-solid fa-triangle-exclamation"></i>
			  No Blog Created!
			</span>
		      <% } %>

	</div>

  	<div class="p-5 pt-3 text-3xl w-full hidden" id="view-topics">
		<% if(topics.length > 0){
		    topics.forEach((topic) => {
		%>
			<div class="p-1 mt-5 mb-5 w-full flex justify-between bg-smoky-black-700 text-liberty-300 rounded-md items-center">
			  <div class="flex flex-col capitalize p-1">
			    <span class="text-2xl">
			      <%= topic.topic_title %>
			    </span>
			    <span class="text-sm ">
			      <%= topic.topic_description %>
			    </span>
			  </div>
			  <form action="admin/delete_topic?topic_id=<%= topic.topic_id %>" method="post">
			  <button class="mr-5 hover:text-rose-500" type="submit">
			      <i class="fa-solid fa-trash"></i>
			  </button>
			  </form>
			</div>
		<%  })} else { %>
			<span class="text-french-raspberry-600 text-xl font-semibold mt-5 p-2">
			  <i class="fa-solid fa-triangle-exclamation"></i>
			  No Saved Topics!
			</span>
		<% } %>
	</div>


  </div>
	<% if(locals.edit_blog && edit_blog == true){ %>
			<div class="w-screen h-screen bg-smoky-black-800 z-50
			  absolute top-0 left-0 flex items-center flex-col space-y-5 overflow-x-hidden overscroll-y-auto"
			  id="edit-<%= blog.blog_id %>">
			  <div class="flex p-2 justify-between bg-smoky-black-900/50 w-full">
			    <span class="font-semibold text-2xl">
			      EDIT - <%= blog.blog_title %>
			    </span>
			    <button class="text-3xl text-liberty-200 hover:text-rose-500 mr-5" 
			    onclick="document.getElementById('edit-<%= blog.blog_id %>').remove()">
				  <i class="fa-solid fa-xmark"></i>
				</button> 	
			  </div>
			  <form action="admin/update_blog/<%= blog.blog_id %>" method="post" class="w-[80%] text-3xl">
			<input type="text" class="p-2 text-md w-full bg-smoky-black-700 mb-8 mt-3 text-liberty-400 rounded-md" placeholder="Title ~ Untitled" name="blog_title" value="<%= blog.blog_title %>">
			<textarea class="blog-editor" name="blog_content"><%- blog.blog_content %></textarea>
			<textarea type="text" name="blog_description" class="p-2 text-md w-full bg-smoky-black-700 mb-5 mt-8 text-liberty-400 rounded-md" placeholder="Description ~"><%= blog.blog_description %></textarea>
		      <select name="blog_topic"
			class="text-md p-1 w-full bg-smoky-black-700 mb-5
			text-liberty-400 rounded-md">
			<option disabled hidden>Select Topic</option>
			<% topics.forEach((topic) => { %>
			<option value="<%= topic.topic_id %>"
			<% if(topic.topic_id == blog.blog_topic){ %> selected <% } %>
			>
			<%= topic.topic_title %>
			</option>
			<% }) %>
		      </select>
		      <button class="bg-liberty-600 text-smoky-black-200 p-2 w-full rounded-md 
			hover:bg-liberty-700 mb-10">
			Save
		      </button>
		      </form>
		      </div>
	<% } %>
</div>
</div>
<%- include("../partials/foot"); %>
